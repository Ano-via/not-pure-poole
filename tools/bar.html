---
layout: default
title: "自动替换换行符为“|”"
permalink: bar.html
---

<div class="nl2pipe-wrapper">
  <input type="file" id="xlsxInput" accept=".xlsx" />

  <textarea id="textarea1" placeholder="Excel 处理结果会自动填充到这里"></textarea>
  <textarea id="textarea2" placeholder="自动生成 | 并复制" readonly></textarea>
</div>

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
.nl2pipe-wrapper {
  max-width: 600px;
}

.nl2pipe-wrapper textarea {
  width: 100%;
  min-height: 120px;
  padding: 10px;
  margin-top: 10px;
  box-sizing: border-box;
}

.nl2pipe-wrapper textarea.copied {
  background-color: #d4f8d4;
  transition: background-color 0.3s ease;
}
</style>

<script>
(() => {
  const fileInput = document.getElementById('xlsxInput');
  const t1 = document.getElementById('textarea1');
  const t2 = document.getElementById('textarea2');
  let timer = null;

  /* 复制 + 变色 */
  const copyAndFlash = async (text) => {
    if (!text) return;
    try {
      await navigator.clipboard.writeText(text);
      t2.classList.add('copied');
      clearTimeout(timer);
      timer = setTimeout(() => t2.classList.remove('copied'), 3000);
    } catch {}
  };

  /* textarea1 → textarea2 */
  t1.addEventListener('input', () => {
    const result = t1.value.replace(/\r?\n+/g, '|');
    t2.value = result;
    copyAndFlash(result);
  });

  /* 点击 textarea2 手动复制 */
  t2.addEventListener('click', () => {
    t2.select();
    copyAndFlash(t2.value);
  });

  /* Excel 处理核心逻辑 */
  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (evt) => {
      const workbook = XLSX.read(evt.target.result, { type: 'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];

      const range = XLSX.utils.decode_range(sheet['!ref']);
      const results = new Set();

      for (let r = 2; r <= range.e.r; r++) { // 从第3行开始（0基）
        const cell = sheet[XLSX.utils.encode_cell({ r, c: 29 })]; // AD 列 = 29
        if (!cell || !cell.v) continue;

        let val = String(cell.v).trim();
        val = val.split('-')[0];
        val = val.split('@')[0];
        val = val.split('_')[0];

        if (val) results.add(val);
      }

      t1.value = Array.from(results).join('\n');
      t1.dispatchEvent(new Event('input')); // 自动触发后续流程
    };

    reader.readAsArrayBuffer(file);
  });
})();
</script>
